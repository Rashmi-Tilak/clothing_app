<!DOCTYPE html>
{% extends 'base.html' %}

{% block content %}
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        /* style.css */

/* Reset some default browser styles */
body, ul, li {
    margin: 0;
    padding: 0;
    list-style: none;
}

/* Center the content vertically and horizontally */
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: Arial, sans-serif;
    background-color: #f0f0f0; /* Optional: Set the background color */
}

/* Style the product list and items */
.product-list {
    margin-top: 20px;
}

.product-item {
    border: 1px solid #ccc;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
    background-color: #fff;
}

.product-name {
    font-size: 24px;
    color: #333;
}

.product-description {
    font-size: 16px;
    color: #555;
    margin-bottom: 10px;
}

.product-price {
    font-size: 18px;
    font-weight: bold;
    color: #00b300; /* Green color for price */
}

/* Style the images and variants */
.product-subtitle {
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    margin-bottom: 5px;
}
 .image-scroll-container {
            max-height: 200px; /* Set the maximum height for the scrolling window */
            overflow: hidden; /* Hide the overflow to create the scrolling effect */
            white-space: nowrap; /* Prevent images from wrapping to a new line */
            display: flex; /* Use flexbox to align images */
            align-items: center; /* Center images vertically */
            transition: transform 0.3s; /* Smooth scrolling transition */
        }

        /* Style the individual image item */
        .image-item {
            padding: 5px;
            /* Optionally, you can add a fixed width to each image to keep them in a grid-like layout */
            max-width: 100px;
            display: inline-block; /* Display images side by side */
        }

        .image-item img {
            max-width: 100%;
            max-height: 100px;
        }
.variant-list {
    margin-top: 10px;
}

.variant-item {
    font-size: 14px;
    color: #666;
}
.variant-list {
        margin-top: 10px;
    }

.variant-item {
    font-size: 14px;
    color: #666;
}

/* Style the size checkbox */
.size-checkbox {
    margin-right: 10px;
}
.image-scroll-container {
    max-height: 200px; /* Set the maximum height for the scrolling window */
    overflow-y: auto; /* Enable vertical scrolling */
}
 .disabledButton {
            background-color: gray;
            cursor: not-allowed;
        }


.itemAddedButton {
    background-color: green !important;
    pointer-events: none !important;
}
    </style>
</head>
<body>
  <div class="container">

        <ul class="product-list">
            {% for product in result_list %}
            <li class="product-item">
                <h2 class="product-name">{{ product.name }}</h2>
                <p class="product-description">{{ product.description }}</p>
                <p class="product-price">Price: ${{ product.price }}</p>

                {% if product.images %}
                    <h3 class="product-subtitle">Images:</h3>
                <div class="image-scroll-container">
                    <ul class="image-list">
                        {% for image in product.images %}
                            <li class="image-item"><img src="{{ image }}" alt="Product Image"></li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

<!--                 <button class="addToCartButton" data-item-id="{{ product.product_id }}" style="background-color: black; color: white;width: 140px; height: 35px;font-weight: bold;" onclick="addToCart({{ product.product_id }})">Add to cart</button>-->
                <button class="addToCartButton" data-item-id="{{ product.product_id }}" style="background-color: {% if product.disable %}gray{% else %}black{% endif %}; color: white;width: 140px; height: 35px;font-weight: bold;" onclick="addToCart({{ product.product_id }})" {% if product.disable %}disabled{% endif %}>Add to cart</button>

<!--                <button id="apiButton" class="addToWishlistButton" data-item-id="{{ product.product_id }}" style="background-color: black; color: white;width: 140px; height: 35px;font-weight: bold;" >WishList</button>-->
                <button id="wishlistButton" class="addToWishlistButton" data-item-id="{{ product.product_id }}" data-wish-status="{{ product.wish_status_disable }}" onclick="addToWishlist({{ product.product_id }})" style="background-color: {% if product.wish_status_disable %}red{% else %}black{% endif %}; color: white;width: 140px; height: 35px;font-weight: bold;" {% if product.wish_status_disable %}disabled{% endif %}>WishList</button>


                {% if product.variants %}
                    <h3 class="product-subtitle">Variants:</h3>
                    <ul class="variant-list">
                        {% for variant in product.variants %}
                        <li class="variant-item">
                            <input type="checkbox" data-item-id="{{ product.product_id }}" class="size-checkbox" name="size" value="{{ variant.size }}" {% if product.disable %}disabled{% endif %}>
                            <label {% if product.disable %}style="color: blue;"{% endif %}>Size: {{ variant.size }}</label>
                            <input type="checkbox" data-item-id="{{ product.product_id }}" class="color-checkbox" name="color" value="{{ variant.color }}" {% if product.disable %}disabled{% endif %}>
                            <label {% if product.disable %}style="color: blue;"{% endif %}>Color: {{ variant.color }}</label>
                        </li>
                        {% endfor %}
                    </ul>

                {% endif %}
            </li>

            {% endfor %}

        </ul>
    </div>

<script>
     apiCallCount = 0
     function isCartButtonDisabled(productId)
      {
            // Check if the button is already disabled for the specific product
            return localStorage.getItem(`cartButtonDisabled_${productId}`) === 'true';
      }




     function setItemAddedText(productId)
     {
      const cartButton = document.querySelector(`button.addToCartButton[data-item-id="${productId}"]`);
      console.log("cartButton",cartButton)
<!--      cartButton.textContent = 'Item Added';-->
<!--      cartButton.classList.add('itemAddedButton');-->
      cartButton.style.width = '140px'; // Set the width to the original width of the button
    }

     function isCheckboxesDisabled(productId)
      {
            // Check if the button is already disabled for the specific product
            return localStorage.getItem(`checkboxDisabled_${productId}`) === 'true';
      }

    function disableCheckboxes(productId) {
      // Disable the size and color checkboxes for the specific product
      const sizeCheckboxes = document.querySelectorAll(`input[type="checkbox"].size-checkbox[data-item-id="${productId}"]`);
      const colorCheckboxes = document.querySelectorAll(`input[type="checkbox"].color-checkbox[data-item-id="${productId}"]`);

      sizeCheckboxes.forEach((checkbox) => {
        checkbox.disabled = true;
        // Store the disabled state in session storage with a unique key for each checkbox
        localStorage.setItem(`checkboxDisabled_${productId}_${checkbox.id}`, 'true');
      });

      colorCheckboxes.forEach((checkbox) => {
        checkbox.disabled = true;
        // Store the disabled state in session storage with a unique key for each checkbox
        localStorage.setItem(`checkboxDisabled_${productId}_${checkbox.id}`, 'true');
      });
    }


    function disableCartButton(productId)
    {
        // Disable the cart button and store its state in the session storage
        localStorage.setItem(`cartButtonDisabled_${productId}`, 'true');
        const cartButton = document.querySelector(`button.addToCartButton[data-item-id="${productId}"]`);
        cartButton.disabled = true;
    }




       function addToCart(productId) {
       console.log("*****",isCartButtonDisabled(productId))
        if (isCartButtonDisabled(productId)) {
            // If the cart button is already disabled, do not proceed
            return;
        }
        if (isCheckboxesDisabled(productId)) {
           return;
        }

        const selectedSizes = document.querySelectorAll(`input[type="checkbox"].size-checkbox[data-item-id="${productId}"]:checked`);
        const selectedColors = document.querySelectorAll(`input[type="checkbox"].color-checkbox[data-item-id="${productId}"]:checked`);


        if (selectedSizes.length === 0 || selectedColors.length === 0) {
            alert('Please select a size and a color before adding to the cart.');
            return;
        }

        // Create arrays to store the selected size and color variants
        const selectedSizeVariants = [];
        const selectedColorVariants = [];

        selectedSizes.forEach((checkbox) => {
            selectedSizeVariants.push(checkbox.value);
        });

        selectedColors.forEach((checkbox) => {
            selectedColorVariants.push(checkbox.value);
        });

        // Prepare the data to be sent in the POST request
        const data = {
            product_id: productId,
            size_variants: selectedSizeVariants,
            color_variants: selectedColorVariants,
        };

        // Send the POST request to the cart API endpoint
        fetch('/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}', // Include the CSRF token if you are using it for CSRF protection
            },
            body: JSON.stringify(data),
        })
       .then((response) => {
            if (response.ok) {
                return response.json()
                    .catch((error) => {
                        throw new Error('Failed to parse JSON response from the server.');
                    })
                    .then((responseData) => {
                        console.log("Response Data:", responseData);
                        return responseData; // Return the parsed JSON data
                    });
            } else {
                throw new Error('Failed to add the product to the cart.');
            }
        })
        .then((responseData) => {
            console.log("Inside hear")
            // Process the responseData and update the cart view accordingly
            // Optionally, you can display a success message to the user indicating that the product has been added to the cart.
<!--            alert('Product added to cart successfully.');-->
            setItemAddedText(productId);
            disableCartButton(productId);
               disableCheckboxes(productId);

            // Reload the page after displaying the success message
            window.location.reload();
        })
        .catch((error) => {
            console.error("this is the error", error);
            alert('Failed to add the product to the cart. Please try again.');
        });
    }



     function addToWishlist(productId) {
       console.log("*****",isCartButtonDisabled(productId))



        // Prepare the data to be sent in the POST request
        const data = {
            product_id: productId,
        };

        // Send the POST request to the cart API endpoint
        fetch('/wishlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}', // Include the CSRF token if you are using it for CSRF protection
            },
            body: JSON.stringify(data),
        })
       .then((response) => {
            console.log("response ******",response)
            if (response.ok) {
                return response.json()
                    .catch((error) => {
                        throw new Error('Failed to parse JSON response from the server.');
                    })
                    .then((responseData) => {
                        console.log("Response Data:", responseData);
                        window.location.reload();
                        return responseData; // Return the parsed JSON data
                    });
            } else {
                throw new Error('Failed to add the product to the wishlist.');
            }
        })
        .then((responseData) => {
            console.log("Inside hear")


        })
        .catch((error) => {
            console.error("this is the error", error);
            alert('Failed to add the product to the wishlist. Please try again.');
        });
    }





     document.addEventListener('DOMContentLoaded', () => {
        const cartButtons = document.querySelectorAll('button.addToCartButton');
        cartButtons.forEach((cartButton) => {
            const productId = cartButton.dataset.itemId;
            if (isCartButtonDisabled(productId)) {
                cartButton.disabled = true;
                cartButton.classList.add('disabledButton');
            }
        });
    });


    </script>

</body>
</html>
{% endblock %}